<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý Dự án & Báo cáo - Supabase</title>
    
    <!-- Supabase JS v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .login-box h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .google-login-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: white;
            border: 2px solid #4285f4;
            color: #4285f4;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        .google-login-btn:hover {
            background: #4285f4;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(66, 133, 244, 0.3);
        }
        
        .google-login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .google-icon {
            width: 20px;
            height: 20px;
        }
        
        /* Main App Styles */
        .app-container {
            display: none;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
            border: 2px solid white;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #333;
        }
        
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        
        .close:hover {
            color: #000;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .task-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #fcc;
        }
        
        .success {
            background: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #cfc;
        }
        
        .info {
            background: #e3f2fd;
            color: #1976d2;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #bbdefb;
        }
        
        .no-permission {
            text-align: center;
            padding: 10px;
            color: #999;
            font-size: 12px;
        }
        
        .config-section {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .config-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }
        
        .config-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ffc107;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Configuration Section -->
    <div id="configSection" class="login-container" style="display: none;">
        <div class="login-box" style="max-width: 600px;">
            <h1>Cấu hình Supabase</h1>
            <div class="config-section">
                <h3>⚠️ Chưa cấu hình kết nối Supabase</h3>
                <p style="margin-bottom: 15px;">Vui lòng nhập thông tin từ Supabase Dashboard:</p>
                
                <div class="form-group" style="text-align: left;">
                    <label>Project URL:</label>
                    <input type="text" id="configUrl" class="config-input" 
                           placeholder="https://xxxxx.supabase.co">
                </div>
                
                <div class="form-group" style="text-align: left;">
                    <label>Anon Key:</label>
                    <textarea id="configKey" class="config-input" rows="3" 
                              placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="saveConfig()">Lưu và Kết nối</button>
                
                <div style="margin-top: 20px; text-align: left; font-size: 12px; color: #666;">
                    <strong>Hướng dẫn:</strong>
                    <ol style="padding-left: 20px;">
                        <li>Đăng nhập vào Supabase Dashboard</li>
                        <li>Chọn project của bạn</li>
                        <li>Vào Settings → API</li>
                        <li>Copy Project URL và anon key</li>
                        <li>Dán vào form trên và nhấn Lưu</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h1>Hệ thống Quản lý Dự án</h1>
            <p style="margin-bottom: 30px; color: #666;">Vui lòng đăng nhập để tiếp tục</p>
            <button class="google-login-btn" onclick="loginWithGoogle()">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span class="btn-text">Đăng nhập với Google</span>
            </button>
            <div id="loginError" class="error" style="display: none; margin-top: 20px;"></div>
            <div id="loginInfo" class="info" style="display: none; margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="app-container">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>Hệ thống Quản lý Dự án & Báo cáo Tuần</h1>
                <div class="user-info">
                    <div>
                        <img id="userAvatar" class="user-avatar" src="" alt="">
                        <span id="userName">Đang tải...</span> | 
                        <span id="userRole">...</span> | 
                        <span id="userCode">...</span>
                    </div>
                    <button class="btn btn-secondary" onclick="logout()">Đăng xuất</button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showSection('projects')">Dự án</button>
                <button class="tab" onclick="showSection('tasks')">Công việc</button>
                <button class="tab" onclick="showSection('weekly-reports')">Báo cáo tuần</button>
                <button class="tab" onclick="showSection('activity')">Hoạt động tuần</button>
                <button class="tab" onclick="showSection('progress')">Tiến độ dự án</button>
            </div>

            <!-- Main Content -->
            <div class="content">
                <!-- Projects Section -->
                <div id="projects" class="section active">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Quản lý Dự án</h2>
                        <button class="btn btn-primary" id="addProjectBtn" onclick="showProjectModal()">+ Thêm dự án mới</button>
                    </div>
                    <div class="table-container">
                        <table id="projectsTable">
                            <thead>
                                <tr>
                                    <th>Mã dự án</th>
                                    <th>Tên dự án</th>
                                    <th>Khách hàng</th>
                                    <th>Mô tả</th>
                                    <th>Ngày bắt đầu</th>
                                    <th>Ngày kết thúc</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="8" class="loading"><div class="loading-spinner"></div> Đang tải dữ liệu...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tasks Section -->
                <div id="tasks" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Quản lý Công việc</h2>
                        <button class="btn btn-primary" onclick="showTaskModal()">+ Thêm công việc mới</button>
                    </div>
                    <div class="filters">
                        <div class="filter-group">
                            <label>Lọc theo dự án:</label>
                            <select class="form-control" id="taskProjectFilter" onchange="loadTasks()">
                                <option value="">Tất cả dự án</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Lọc theo người thực hiện:</label>
                            <select class="form-control" id="taskUserFilter" onchange="loadTasks()">
                                <option value="">Tất cả người dùng</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="tasksTable">
                            <thead>
                                <tr>
                                    <th>Mã công việc</th>
                                    <th>Dự án</th>
                                    <th>Người thực hiện</th>
                                    <th>Tên công việc</th>
                                    <th>Mô tả</th>
                                    <th>Ngày bắt đầu</th>
                                    <th>Ngày kết thúc</th>
                                    <th>Tiến độ (%)</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="10" class="loading"><div class="loading-spinner"></div> Đang tải dữ liệu...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Weekly Reports Section -->
                <div id="weekly-reports" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Báo cáo Tuần</h2>
                        <button class="btn btn-primary" onclick="showWeeklyReportModal()">+ Tạo báo cáo tuần</button>
                    </div>
                    <div class="filters">
                        <div class="filter-group">
                            <label>Năm:</label>
                            <select class="form-control" id="reportYearFilter" onchange="loadWeeklyReports()">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Tuần:</label>
                            <select class="form-control" id="reportWeekFilter" onchange="loadWeeklyReports()">
                                <option value="">Tất cả các tuần</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="weeklyReportsTable">
                            <thead>
                                <tr>
                                    <th>Mã báo cáo</th>
                                    <th>Người tạo</th>
                                    <th>Tuần</th>
                                    <th>Năm</th>
                                    <th>Ghi chú</th>
                                    <th>Trạng thái</th>
                                    <th>Ngày nộp</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="8" class="loading"><div class="loading-spinner"></div> Đang tải dữ liệu...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- User Activity Section -->
                <div id="activity" class="section">
                    <h2>Hoạt động Tuần của Nhân viên</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label>Năm:</label>
                            <select class="form-control" id="activityYearFilter" onchange="loadActivity()">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Từ tuần:</label>
                            <input type="number" class="form-control" id="activityWeekFrom" min="1" max="53" value="1" onchange="loadActivity()">
                        </div>
                        <div class="filter-group">
                            <label>Đến tuần:</label>
                            <input type="number" class="form-control" id="activityWeekTo" min="1" max="53" value="53" onchange="loadActivity()">
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="activityTable">
                            <thead>
                                <tr>
                                    <th>Năm</th>
                                    <th>Tuần</th>
                                    <th>Nhân viên</th>
                                    <th>Mã NV</th>
                                    <th>Dự án</th>
                                    <th>Khách hàng</th>
                                    <th>Số công việc</th>
                                    <th>Giờ làm</th>
                                    <th>Tiến độ TB (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="9" class="loading"><div class="loading-spinner"></div> Đang tải dữ liệu...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Project Progress Section -->
                <div id="progress" class="section">
                    <h2>Tiến độ Tổng thể Dự án</h2>
                    <div class="stats-grid" id="progressStats">
                        <!-- Stats cards will be inserted here -->
                    </div>
                    <div class="table-container">
                        <table id="progressTable">
                            <thead>
                                <tr>
                                    <th>Mã dự án</th>
                                    <th>Tên dự án</th>
                                    <th>Khách hàng</th>
                                    <th>Ngày bắt đầu</th>
                                    <th>Ngày kết thúc</th>
                                    <th>Trạng thái</th>
                                    <th>Tổng công việc</th>
                                    <th>Đã hoàn thành</th>
                                    <th>Tiến độ (%)</th>
                                    <th>Giờ ước tính</th>
                                    <th>Giờ đã làm</th>
                                    <th>Số thành viên</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="12" class="loading"><div class="loading-spinner"></div> Đang tải dữ liệu...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="projectModalTitle">Thêm Dự án mới</h2>
                <span class="close" onclick="closeModal('projectModal')">&times;</span>
            </div>
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <div class="form-group">
                    <label>Tên dự án *</label>
                    <input type="text" class="form-control" id="projName" required>
                </div>
                <div class="form-group">
                    <label>Khách hàng</label>
                    <input type="text" class="form-control" id="customer">
                </div>
                <div class="form-group">
                    <label>Mô tả</label>
                    <textarea class="form-control" id="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Ngày bắt đầu</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="form-group">
                    <label>Ngày kết thúc</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="form-group">
                    <label>Trạng thái</label>
                    <select class="form-control" id="status">
                        <option value="active">Đang hoạt động</option>
                        <option value="completed">Đã hoàn thành</option>
                        <option value="paused">Tạm dừng</option>
                    </select>
                </div>
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Lưu</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('projectModal')">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="taskModalTitle">Thêm Công việc mới</h2>
                <span class="close" onclick="closeModal('taskModal')">&times;</span>
            </div>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <div class="form-group">
                    <label>Dự án *</label>
                    <select class="form-control" id="taskProjectId" required>
                        <option value="">Chọn dự án</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Người thực hiện *</label>
                    <select class="form-control" id="taskUserId" required>
                        <option value="">Chọn người thực hiện</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tên công việc *</label>
                    <input type="text" class="form-control" id="taskName" required>
                </div>
                <div class="form-group">
                    <label>Mô tả</label>
                    <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Ngày bắt đầu</label>
                    <input type="date" class="form-control" id="taskStartDate">
                </div>
                <div class="form-group">
                    <label>Ngày kết thúc</label>
                    <input type="date" class="form-control" id="taskEndDate">
                </div>
                <div class="form-group">
                    <label>Thời gian ước tính (giờ)</label>
                    <input type="number" class="form-control" id="totalDuration" min="0" step="0.5">
                </div>
                <div class="form-group">
                    <label>Tiến độ (%)</label>
                    <input type="number" class="form-control" id="progressPct" min="0" max="100" value="0">
                </div>
                <div class="form-group">
                    <label>Trạng thái</label>
                    <select class="form-control" id="taskStatus">
                        <option value="pending">Chờ xử lý</option>
                        <option value="in_progress">Đang thực hiện</option>
                        <option value="completed">Đã hoàn thành</option>
                    </select>
                </div>
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Lưu</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('taskModal')">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Weekly Report Modal -->
    <div id="weeklyReportModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="weeklyReportModalTitle">Tạo/Sửa Báo cáo Tuần</h2>
                <span class="close" onclick="closeModal('weeklyReportModal')">&times;</span>
            </div>
            <form id="weeklyReportForm">
                <input type="hidden" id="wReportId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Năm *</label>
                        <input type="number" class="form-control" id="reportYear" min="2024" max="2030" required>
                    </div>
                    <div class="form-group">
                        <label>Tuần ISO *</label>
                        <input type="number" class="form-control" id="isoWeek" min="1" max="53" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ghi chú báo cáo</label>
                    <textarea class="form-control" id="reportNote" rows="3"></textarea>
                </div>
                
                <h3 style="margin-top: 30px; margin-bottom: 15px;">Chi tiết công việc trong tuần</h3>
                <div id="weeklyTasksContainer">
                    <button type="button" class="btn btn-secondary" onclick="addWeeklyTask()">+ Thêm công việc</button>
                    <div id="weeklyTasksList" style="margin-top: 15px;">
                        <!-- Tasks will be dynamically added here -->
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <button type="submit" class="btn btn-primary">Lưu báo cáo</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('weeklyReportModal')">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        let SUPABASE_URL = localStorage.getItem('https://vtuytabzqlxjbfpeniit.supabase.co') || '';
        let SUPABASE_ANON_KEY = localStorage.getItem('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0dXl0YWJ6cWx4amJmcGVuaWl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzY2NDksImV4cCI6MjA2OTk1MjY0OX0.NVSpMhIn8GVqKfbOHglkoZnCUDyS4gFR0xyHIAoxNZ8') || '';
        
        let supabase = null;
        let currentUser = null;
        let db = {
            projects: [],
            tasks: [],
            users: [],
            weeklyReports: [],
            activities: []
        };

        // Check configuration on load
        function checkConfiguration() {
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY || 
                SUPABASE_URL === 'https://vtuytabzqlxjbfpeniit.supabase.co' || 
                SUPABASE_ANON_KEY === 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0dXl0YWJ6cWx4amJmcGVuaWl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzY2NDksImV4cCI6MjA2OTk1MjY0OX0.NVSpMhIn8GVqKfbOHglkoZnCUDyS4gFR0xyHIAoxNZ8') {
                document.getElementById('configSection').style.display = 'flex';
                document.getElementById('loginPage').style.display = 'none';
                return false;
            }
            return true;
        }

        // Save configuration
        function saveConfig() {
            const url = document.getElementById('configUrl').value.trim();
            const key = document.getElementById('configKey').value.trim();
            
            if (!url || !key) {
                alert('Vui lòng nhập đầy đủ thông tin!');
                return;
            }
            
            localStorage.setItem('SUPABASE_URL', url);
            localStorage.setItem('SUPABASE_ANON_KEY', key);
            
            SUPABASE_URL = url;
            SUPABASE_ANON_KEY = key;
            
            // Reload page to initialize with new config
            window.location.reload();
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing app...');
            
            if (!checkConfiguration()) {
                return;
            }
            
            // Initialize Supabase client
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase client initialized');
            } catch (error) {
                console.error('Error initializing Supabase:', error);
                alert('Lỗi khởi tạo Supabase. Vui lòng kiểm tra lại cấu hình.');
                document.getElementById('configSection').style.display = 'flex';
                document.getElementById('loginPage').style.display = 'none';
                return;
            }
            
            // Check if user is already logged in
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (error) {
                console.error('Session error:', error);
                showLoginPage();
                return;
            }
            
            if (session) {
                console.log('Existing session found');
                await handleSuccessfulLogin(session);
            } else {
                console.log('No existing session');
                showLoginPage();
            }
            
            // Listen for auth state changes
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth state changed:', event);
                
                if (event === 'SIGNED_IN' && session) {
                    await handleSuccessfulLogin(session);
                } else if (event === 'SIGNED_OUT') {
                    showLoginPage();
                }
            });
        });

        // Login with Google
        async function loginWithGoogle() {
            try {
                const loginBtn = document.querySelector('.google-login-btn');
                const btnText = loginBtn.querySelector('.btn-text');
                loginBtn.disabled = true;
                btnText.textContent = 'Đang chuyển hướng...';
                
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.href.split('#')[0]
                    }
                });
                
                if (error) throw error;
                
            } catch (error) {
                console.error('Login error:', error);
                const loginBtn = document.querySelector('.google-login-btn');
                const btnText = loginBtn.querySelector('.btn-text');
                loginBtn.disabled = false;
                btnText.textContent = 'Đăng nhập với Google';
                
                alert('Lỗi đăng nhập: ' + error.message + '\n\nVui lòng kiểm tra:\n1. Đã bật Google Auth trong Supabase\n2. Đã cấu hình Redirect URLs\n3. Đã nhập Client ID và Secret');
            }
        }

        // Handle successful login
        async function handleSuccessfulLogin(session) {
            try {
                console.log('Handling successful login...');
                
                // Check if email is authorized
                const { data: authorizedEmail, error: authEmailError } = await supabase
                    .from('authorized_emails')
                    .select('*')
                    .eq('email', session.user.email)
                    .eq('is_active', true)
                    .single();
                
                if (authEmailError || !authorizedEmail) {
                    console.error('Email not authorized:', session.user.email);
                    await supabase.auth.signOut();
                    alert('Email của bạn chưa được cấp quyền truy cập hệ thống. Vui lòng liên hệ Admin.');
                    showLoginPage();
                    return;
                }
                
                // Check/create user profile
                const { data: profile, error: profileError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();
                
                if (profileError && profileError.code !== 'PGRST116') {
                    console.error('Profile error:', profileError);
                }
                
                let userProfile = profile;
                
                if (!userProfile) {
                    // Profile will be created by database trigger
                    // Wait a moment and try again
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    const { data: retryProfile } = await supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('id', session.user.id)
                        .single();
                    
                    userProfile = retryProfile;
                }
                
                currentUser = {
                    id: session.user.id,
                    email: session.user.email,
                    displayName: userProfile?.full_name || session.user.email?.split('@')[0] || 'User',
                    photoURL: userProfile?.avatar_url || '',
                    role: userProfile?.role || authorizedEmail.role || 'staff',
                    code_id: userProfile?.code_id || 'N/A',
                    status: userProfile?.status || 'active'
                };
                
                console.log('User logged in:', currentUser);
                showMainApp();
                
            } catch (error) {
                console.error('Error in handleSuccessfulLogin:', error);
                showMainApp(); // Still show app even if profile creation fails
            }
        }

        // Logout
        async function logout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                currentUser = null;
                db = {
                    projects: [],
                    tasks: [],
                    users: [],
                    weeklyReports: [],
                    activities: []
                };
                
                showLoginPage();
            } catch (error) {
                console.error('Logout error:', error);
                alert('Lỗi đăng xuất: ' + error.message);
            }
        }

        // Show login page
        function showLoginPage() {
            document.getElementById('configSection').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        // Show main app
        function showMainApp() {
            document.getElementById('configSection').style.display = 'none';
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.querySelector('.app-container').style.display = 'block';
            updateUserInfo();
            updateUIByRole(); // Update UI based on user role
            loadInitialData();
        }

        // Update UI based on user role
        function updateUIByRole() {
            const role = currentUser?.role || 'staff';
            
            // Hide/show elements based on role
            if (role === 'staff') {
                // Staff cannot create projects
                const projectAddBtns = document.querySelectorAll('[onclick*="showProjectModal()"]');
                projectAddBtns.forEach(btn => {
                    if (!btn.classList.contains('edit-btn')) {
                        btn.style.display = 'none';
                    }
                });
            }
            
            // Update navigation if needed
            if (role === 'admin') {
                // Admin can see everything - maybe add admin panel later
                addAdminMenu();
            }
        }
        
        // Add admin menu for admin users
        function addAdminMenu() {
            const tabs = document.querySelector('.tabs');
            if (!document.getElementById('adminTab')) {
                const adminTab = document.createElement('button');
                adminTab.id = 'adminTab';
                adminTab.className = 'tab';
                adminTab.innerHTML = '⚙️ Quản trị';
                adminTab.onclick = () => showSection('admin');
                tabs.appendChild(adminTab);
                
                // Add admin section to content
                const content = document.querySelector('.content');
                const adminSection = document.createElement('div');
                adminSection.id = 'admin';
                adminSection.className = 'section';
                adminSection.innerHTML = `
                    <h2>Quản trị Hệ thống</h2>
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-value" id="totalUsers">0</div>
                            <div class="stat-label">Tổng người dùng</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="activeUsers">0</div>
                            <div class="stat-label">Đang hoạt động</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalProjects">0</div>
                            <div class="stat-label">Tổng dự án</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="pendingReports">0</div>
                            <div class="stat-label">Báo cáo chờ duyệt</div>
                        </div>
                    </div>
                    <h3>Quản lý Email được phép truy cập</h3>
                    <button class="btn btn-primary" onclick="showAddEmailModal()">+ Thêm Email</button>
                    <div class="table-container">
                        <table id="authorizedEmailsTable">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Vai trò</th>
                                    <th>Trạng thái</th>
                                    <th>Người thêm</th>
                                    <th>Ngày thêm</th>
                                    <th>Ghi chú</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="7" class="loading">Đang tải...</td></tr>
                            </tbody>
                        </table>
                    </div>
                `;
                content.appendChild(adminSection);
            }
        }

        // Update user info
        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.displayName;
                document.getElementById('userRole').textContent = getRoleDisplay(currentUser.role);
                document.getElementById('userCode').textContent = `Mã: ${currentUser.code_id}`;
                
                const avatar = document.getElementById('userAvatar');
                avatar.src = currentUser.photoURL || 
                    `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName)}&background=667eea&color=fff`;
            }
        }

        function getRoleDisplay(role) {
            const roleMap = {
                'admin': 'Quản trị viên',
                'pm': 'Quản lý dự án',
                'staff': 'Nhân viên'
            };
            return roleMap[role] || role;
        }

        // Tab navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            
            // Check permissions and show/hide buttons
            const role = currentUser?.role || 'staff';
            
            switch(sectionId) {
                case 'projects':
                    // Hide add button for staff
                    const addProjectBtn = document.getElementById('addProjectBtn');
                    if (addProjectBtn) {
                        addProjectBtn.style.display = checkPermission('create', 'project') ? 'inline-block' : 'none';
                    }
                    loadProjects();
                    break;
                case 'tasks':
                    loadTasks();
                    break;
                case 'weekly-reports':
                    loadWeeklyReports();
                    break;
                case 'activity':
                    loadActivity();
                    break;
                case 'progress':
                    loadProgress();
                    break;
                case 'admin':
                    if (role === 'admin') {
                        loadAdminData();
                    }
                    break;
            }
        }
        
        // Load admin data
        async function loadAdminData() {
            try {
                // Load authorized emails
                const { data: emails, error: emailsError } = await supabase
                    .from('authorized_emails')
                    .select('*')
                    .order('email');
                
                if (emailsError) throw emailsError;
                
                displayAuthorizedEmails(emails);
                
                // Load statistics
                const { data: stats, error: statsError } = await supabase
                    .rpc('get_admin_stats');
                
                if (!statsError && stats) {
                    document.getElementById('totalUsers').textContent = stats.total_users || 0;
                    document.getElementById('activeUsers').textContent = stats.active_users || 0;
                    document.getElementById('totalProjects').textContent = stats.total_projects || 0;
                    document.getElementById('pendingReports').textContent = stats.pending_reports || 0;
                }
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }
        
        // Display authorized emails
        function displayAuthorizedEmails(emails) {
            const tbody = document.querySelector('#authorizedEmailsTable tbody');
            
            if (!emails || emails.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Không có dữ liệu</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            emails.forEach(email => {
                tbody.innerHTML += `
                    <tr>
                        <td>${email.email}</td>
                        <td>${getRoleDisplay(email.role)}</td>
                        <td>${email.is_active ? 
                            '<span style="color: green;">✓ Hoạt động</span>' : 
                            '<span style="color: red;">✗ Vô hiệu</span>'}</td>
                        <td>${email.added_by || 'System'}</td>
                        <td>${formatDate(email.added_at)}</td>
                        <td>${email.notes || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="toggleEmailStatus('${email.email}', ${email.is_active})">
                                ${email.is_active ? 'Vô hiệu' : 'Kích hoạt'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteAuthorizedEmail('${email.email}')">Xóa</button>
                        </td>
                    </tr>
                `;
            });
        }
        
        // Toggle email status
        async function toggleEmailStatus(email, currentStatus) {
            try {
                const { error } = await supabase
                    .from('authorized_emails')
                    .update({ is_active: !currentStatus })
                    .eq('email', email);
                
                if (error) throw error;
                
                await loadAdminData();
                showSuccess('Đã cập nhật trạng thái email!');
            } catch (error) {
                console.error('Error toggling email status:', error);
                alert('Lỗi cập nhật trạng thái: ' + error.message);
            }
        }
        
        // Delete authorized email
        async function deleteAuthorizedEmail(email) {
            if (!confirm(`Bạn có chắc muốn xóa email ${email}?`)) return;
            
            try {
                const { error } = await supabase
                    .from('authorized_emails')
                    .delete()
                    .eq('email', email);
                
                if (error) throw error;
                
                await loadAdminData();
                showSuccess('Đã xóa email!');
            } catch (error) {
                console.error('Error deleting email:', error);
                alert('Lỗi xóa email: ' + error.message);
            }
        }

        // Load initial data
        async function loadInitialData() {
            try {
                const { data: users, error: usersError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .order('full_name');
                
                if (usersError) throw usersError;
                db.users = users || [];
                
                await loadProjects();
                populateFilters();
                populateWeekFilter();
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }

        // Load projects
        async function loadProjects() {
            try {
                const tbody = document.querySelector('#projectsTable tbody');
                tbody.innerHTML = '<tr><td colspan="8" class="loading"><div class="loading-spinner"></div> Đang tải dữ liệu...</td></tr>';
                
                const { data: projects, error } = await supabase
                    .from('projects')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                db.projects = projects || [];
                displayProjects(db.projects);
            } catch (error) {
                console.error('Error loading projects:', error);
                const tbody = document.querySelector('#projectsTable tbody');
                tbody.innerHTML = `<tr><td colspan="8" class="error">Lỗi: ${error.message}</td></tr>`;
            }
        }

        function displayProjects(projects) {
            const tbody = document.querySelector('#projectsTable tbody');
            
            if (!projects || projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Không có dữ liệu</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            projects.forEach(project => {
                tbody.innerHTML += `
                    <tr>
                        <td>${project.project_id}</td>
                        <td>${project.proj_name}</td>
                        <td>${project.customer || '-'}</td>
                        <td>${project.description || '-'}</td>
                        <td>${formatDate(project.start_date)}</td>
                        <td>${formatDate(project.end_date)}</td>
                        <td>${getStatusBadge(project.status)}</td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-sm btn-primary" onclick="editProject('${project.project_id}')">Sửa</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProject('${project.project_id}')">Xóa</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        // Load tasks
        async function loadTasks() {
            try {
                const tbody = document.querySelector('#tasksTable tbody');
                tbody.innerHTML = '<tr><td colspan="10" class="loading"><div class="loading-spinner"></div> Đang tải dữ liệu...</td></tr>';
                
                let query = supabase
                    .from('tasks')
                    .select(`
                        *,
                        project:projects(proj_name),
                        user:user_profiles(full_name)
                    `)
                    .order('created_at', { ascending: false });
                
                const projectFilter = document.getElementById('taskProjectFilter')?.value;
                const userFilter = document.getElementById('taskUserFilter')?.value;
                
                if (projectFilter) {
                    query = query.eq('project_id', projectFilter);
                }
                if (userFilter) {
                    query = query.eq('user_id', userFilter);
                }
                
                const { data: tasks, error } = await query;
                
                if (error) throw error;
                
                db.tasks = tasks || [];
                displayTasks(db.tasks);
            } catch (error) {
                console.error('Error loading tasks:', error);
                const tbody = document.querySelector('#tasksTable tbody');
                tbody.innerHTML = `<tr><td colspan="10" class="error">Lỗi: ${error.message}</td></tr>`;
            }
        }

        function displayTasks(tasks) {
            const tbody = document.querySelector('#tasksTable tbody');
            
            if (!tasks || tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Không có dữ liệu</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            tasks.forEach(task => {
                const canEdit = checkPermission('update', 'task', task);
                const canDelete = checkPermission('delete', 'task', task);
                
                tbody.innerHTML += `
                    <tr>
                        <td>${task.task_id}</td>
                        <td>${task.project?.proj_name || '-'}</td>
                        <td>${task.user?.full_name || '-'}</td>
                        <td>${task.task_name}</td>
                        <td>${task.description || '-'}</td>
                        <td>${formatDate(task.start_date)}</td>
                        <td>${formatDate(task.end_date)}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${task.progress_pct}%"></div>
                            </div>
                            ${task.progress_pct}%
                        </td>
                        <td>${getStatusBadge(task.status)}</td>
                        <td>
                            <div class="actions">
                                ${canEdit ? `
                                    <button class="btn btn-sm btn-primary" onclick="editTask('${task.task_id}')">Sửa</button>
                                ` : ''}
                                ${canDelete ? `
                                    <button class="btn btn-sm btn-danger" onclick="deleteTask('${task.task_id}')">Xóa</button>
                                ` : ''}
                                ${!canEdit && !canDelete ? '<span class="no-permission">Không có quyền</span>' : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        // Load weekly reports
        async function loadWeeklyReports() {
            try {
                const tbody = document.querySelector('#weeklyReportsTable tbody');
                tbody.innerHTML = '<tr><td colspan="8" class="loading"><div class="loading-spinner"></div> Đang tải dữ liệu...</td></tr>';
                
                let query = supabase
                    .from('weekly_reports')
                    .select(`
                        *,
                        user:user_profiles(full_name)
                    `)
                    .order('year', { ascending: false })
                    .order('iso_week', { ascending: false });
                
                const yearFilter = document.getElementById('reportYearFilter')?.value;
                const weekFilter = document.getElementById('reportWeekFilter')?.value;
                
                if (yearFilter) {
                    query = query.eq('year', parseInt(yearFilter));
                }
                if (weekFilter) {
                    query = query.eq('iso_week', parseInt(weekFilter));
                }
                
                const { data: reports, error } = await query;
                
                if (error) throw error;
                
                displayWeeklyReports(reports || []);
            } catch (error) {
                console.error('Error loading weekly reports:', error);
                const tbody = document.querySelector('#weeklyReportsTable tbody');
                tbody.innerHTML = `<tr><td colspan="8" class="error">Lỗi: ${error.message}</td></tr>`;
            }
        }

        function displayWeeklyReports(reports) {
            const tbody = document.querySelector('#weeklyReportsTable tbody');
            
            if (!reports || reports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Không có dữ liệu</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            reports.forEach(report => {
                const canEdit = checkPermission('update', 'report', report);
                const canDelete = checkPermission('delete', 'report', report);
                const canApprove = checkPermission('approve', 'report', report);
                
                tbody.innerHTML += `
                    <tr>
                        <td>${report.report_id}</td>
                        <td>${report.user?.full_name || '-'}</td>
                        <td>${report.iso_week}</td>
                        <td>${report.year}</td>
                        <td>${report.report_note || '-'}</td>
                        <td>${getStatusBadge(report.status)}</td>
                        <td>${formatDate(report.submitted_at)}</td>
                        <td>
                            <div class="actions">
                                ${canEdit ? `
                                    <button class="btn btn-sm btn-primary" onclick="editWeeklyReport(${report.report_id})">Sửa</button>
                                ` : ''}
                                ${canDelete ? `
                                    <button class="btn btn-sm btn-danger" onclick="deleteWeeklyReport(${report.report_id})">Xóa</button>
                                ` : ''}
                                ${canApprove && report.status === 'submitted' ? `
                                    <button class="btn btn-sm btn-success" onclick="approveReport(${report.report_id})">Duyệt</button>
                                    <button class="btn btn-sm btn-warning" onclick="rejectReport(${report.report_id})">Từ chối</button>
                                ` : ''}
                                ${!canEdit && !canDelete && !canApprove ? '<span class="no-permission">Không có quyền</span>' : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });
        }
        
        // Approve report function
        async function approveReport(reportId) {
            if (!confirm('Bạn có chắc muốn duyệt báo cáo này?')) return;
            
            try {
                const { data, error } = await supabase
                    .rpc('approve_weekly_report', { p_report_id: reportId });
                
                if (error) throw error;
                
                await loadWeeklyReports();
                showSuccess('Đã duyệt báo cáo!');
            } catch (error) {
                console.error('Error approving report:', error);
                alert('Lỗi duyệt báo cáo: ' + error.message);
            }
        }
        
        // Reject report function
        async function rejectReport(reportId) {
            const reason = prompt('Lý do từ chối:');
            if (!reason) return;
            
            try {
                const { data, error } = await supabase
                    .rpc('reject_weekly_report', { 
                        p_report_id: reportId,
                        p_reason: reason 
                    });
                
                if (error) throw error;
                
                await loadWeeklyReports();
                showSuccess('Đã từ chối báo cáo!');
            } catch (error) {
                console.error('Error rejecting report:', error);
                alert('Lỗi từ chối báo cáo: ' + error.message);
            }
        }

        // Load activity
        async function loadActivity() {
            try {
                const tbody = document.querySelector('#activityTable tbody');
                tbody.innerHTML = '<tr><td colspan="9" class="loading"><div class="loading-spinner"></div> Đang tải dữ liệu...</td></tr>';
                
                let query = supabase
                    .from('user_activities')
                    .select('*');
                
                const yearFilter = document.getElementById('activityYearFilter')?.value;
                const weekFrom = document.getElementById('activityWeekFrom')?.value;
                const weekTo = document.getElementById('activityWeekTo')?.value;
                
                if (yearFilter) {
                    query = query.eq('year', parseInt(yearFilter));
                }
                if (weekFrom) {
                    query = query.gte('iso_week', parseInt(weekFrom));
                }
                if (weekTo) {
                    query = query.lte('iso_week', parseInt(weekTo));
                }
                
                const { data: activities, error } = await query;
                
                if (error) throw error;
                
                displayActivities(activities || []);
            } catch (error) {
                console.error('Error loading activities:', error);
                const tbody = document.querySelector('#activityTable tbody');
                tbody.innerHTML = `<tr><td colspan="9" class="error">Lỗi: ${error.message}</td></tr>`;
            }
        }

        function displayActivities(activities) {
            const tbody = document.querySelector('#activityTable tbody');
            
            if (!activities || activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Không có dữ liệu</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            activities.forEach(activity => {
                tbody.innerHTML += `
                    <tr>
                        <td>${activity.year}</td>
                        <td>${activity.iso_week}</td>
                        <td>${activity.full_name}</td>
                        <td>${activity.code_id || '-'}</td>
                        <td>${activity.proj_name}</td>
                        <td>${activity.customer || '-'}</td>
                        <td>${activity.task_lines}</td>
                        <td>${activity.hours_week || 0}</td>
                        <td>
                            <div class="progress-bar" style="width: 100px; display: inline-block;">
                                <div class="progress-fill" style="width: ${activity.avg_progress_pct || 0}%"></div>
                            </div>
                            ${activity.avg_progress_pct || 0}%
                        </td>
                    </tr>
                `;
            });
        }

        // Load progress
        async function loadProgress() {
            try {
                const tbody = document.querySelector('#progressTable tbody');
                const statsContainer = document.getElementById('progressStats');
                
                tbody.innerHTML = '<tr><td colspan="12" class="loading"><div class="loading-spinner"></div> Đang tải dữ liệu...</td></tr>';
                
                const { data: progressData, error } = await supabase
                    .from('project_progress')
                    .select('*');
                
                if (error) throw error;
                
                const data = progressData || [];
                
                // Update stats
                const totalProjects = data.length;
                const activeProjects = data.filter(p => p.status === 'active').length;
                const totalHours = data.reduce((sum, p) => sum + (p.hours_spent || 0), 0);
                const avgProgress = totalProjects > 0 
                    ? Math.round(data.reduce((sum, p) => sum + (p.overall_progress_pct || 0), 0) / totalProjects)
                    : 0;
                
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${totalProjects}</div>
                        <div class="stat-label">Tổng số dự án</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${activeProjects}</div>
                        <div class="stat-label">Dự án đang hoạt động</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalHours}h</div>
                        <div class="stat-label">Tổng giờ làm</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${avgProgress}%</div>
                        <div class="stat-label">Tiến độ trung bình</div>
                    </div>
                `;
                
                // Update table
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="12" style="text-align: center;">Không có dữ liệu</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                data.forEach(project => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${project.project_id}</td>
                            <td>${project.proj_name}</td>
                            <td>${project.customer || '-'}</td>
                            <td>${formatDate(project.start_date)}</td>
                            <td>${formatDate(project.end_date)}</td>
                            <td>${getStatusBadge(project.status)}</td>
                            <td>${project.total_tasks || 0}</td>
                            <td>${project.completed_tasks || 0}</td>
                            <td>
                                <div class="progress-bar" style="width: 100px; display: inline-block;">
                                    <div class="progress-fill" style="width: ${project.overall_progress_pct || 0}%"></div>
                                </div>
                                ${project.overall_progress_pct || 0}%
                            </td>
                            <td>${project.total_hours_estimated || 0}h</td>
                            <td>${project.hours_spent || 0}h</td>
                            <td>${project.team_members || 0}</td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error loading progress:', error);
                const tbody = document.querySelector('#progressTable tbody');
                tbody.innerHTML = `<tr><td colspan="12" class="error">Lỗi: ${error.message}</td></tr>`;
            }
        }

        // Modal functions
        function showProjectModal(projectId = null) {
            const modal = document.getElementById('projectModal');
            const title = document.getElementById('projectModalTitle');
            const form = document.getElementById('projectForm');
            
            if (projectId) {
                title.textContent = 'Sửa Dự án';
                const project = db.projects.find(p => p.project_id === projectId);
                if (project) {
                    document.getElementById('projectId').value = project.project_id;
                    document.getElementById('projName').value = project.proj_name;
                    document.getElementById('customer').value = project.customer || '';
                    document.getElementById('description').value = project.description || '';
                    document.getElementById('startDate').value = project.start_date || '';
                    document.getElementById('endDate').value = project.end_date || '';
                    document.getElementById('status').value = project.status;
                }
            } else {
                title.textContent = 'Thêm Dự án mới';
                form.reset();
            }
            
            modal.style.display = 'block';
        }

        function editProject(projectId) {
            showProjectModal(projectId);
        }

        async function deleteProject(projectId) {
            if (!confirm('Bạn có chắc muốn xóa dự án này?')) return;
            
            try {
                const { error } = await supabase
                    .from('projects')
                    .delete()
                    .eq('project_id', projectId);
                
                if (error) throw error;
                
                await loadProjects();
                showSuccess('Xóa dự án thành công!');
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Lỗi xóa dự án: ' + error.message);
            }
        }

        function showTaskModal(taskId = null) {
            const modal = document.getElementById('taskModal');
            const title = document.getElementById('taskModalTitle');
            const form = document.getElementById('taskForm');
            
            populateTaskDropdowns();
            
            if (taskId) {
                title.textContent = 'Sửa Công việc';
                const task = db.tasks.find(t => t.task_id === taskId);
                if (task) {
                    document.getElementById('taskId').value = task.task_id;
                    document.getElementById('taskProjectId').value = task.project_id;
                    document.getElementById('taskUserId').value = task.user_id;
                    document.getElementById('taskName').value = task.task_name;
                    document.getElementById('taskDescription').value = task.description || '';
                    document.getElementById('taskStartDate').value = task.start_date || '';
                    document.getElementById('taskEndDate').value = task.end_date || '';
                    document.getElementById('totalDuration').value = task.total_duration || '';
                    document.getElementById('progressPct').value = task.progress_pct || 0;
                    document.getElementById('taskStatus').value = task.status;
                }
            } else {
                title.textContent = 'Thêm Công việc mới';
                form.reset();
            }
            
            modal.style.display = 'block';
        }

        function populateTaskDropdowns() {
            const projectSelect = document.getElementById('taskProjectId');
            projectSelect.innerHTML = '<option value="">Chọn dự án</option>';
            db.projects.forEach(project => {
                projectSelect.innerHTML += `<option value="${project.project_id}">${project.proj_name}</option>`;
            });
            
            const userSelect = document.getElementById('taskUserId');
            userSelect.innerHTML = '<option value="">Chọn người thực hiện</option>';
            db.users.forEach(user => {
                userSelect.innerHTML += `<option value="${user.id}">${user.full_name}</option>`;
            });
        }

        function editTask(taskId) {
            showTaskModal(taskId);
        }

        async function deleteTask(taskId) {
            if (!confirm('Bạn có chắc muốn xóa công việc này?')) return;
            
            try {
                const { error } = await supabase
                    .from('tasks')
                    .delete()
                    .eq('task_id', taskId);
                
                if (error) throw error;
                
                await loadTasks();
                showSuccess('Xóa công việc thành công!');
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Lỗi xóa công việc: ' + error.message);
            }
        }

        function showWeeklyReportModal(reportId = null) {
            const modal = document.getElementById('weeklyReportModal');
            const title = document.getElementById('weeklyReportModalTitle');
            const form = document.getElementById('weeklyReportForm');
            
            if (reportId) {
                title.textContent = 'Sửa Báo cáo Tuần';
            } else {
                title.textContent = 'Tạo Báo cáo Tuần mới';
                form.reset();
                document.getElementById('reportYear').value = new Date().getFullYear();
                document.getElementById('isoWeek').value = getISOWeek(new Date());
                document.getElementById('weeklyTasksList').innerHTML = '';
            }
            
            modal.style.display = 'block';
        }

        function editWeeklyReport(reportId) {
            showWeeklyReportModal(reportId);
        }

        async function deleteWeeklyReport(reportId) {
            if (!confirm('Bạn có chắc muốn xóa báo cáo này?')) return;
            
            try {
                const { error } = await supabase
                    .from('weekly_reports')
                    .delete()
                    .eq('report_id', reportId);
                
                if (error) throw error;
                
                await loadWeeklyReports();
                showSuccess('Xóa báo cáo thành công!');
            } catch (error) {
                console.error('Error deleting report:', error);
                alert('Lỗi xóa báo cáo: ' + error.message);
            }
        }

        let weeklyTaskIndex = 0;
        function addWeeklyTask() {
            const container = document.getElementById('weeklyTasksList');
            const taskIndex = weeklyTaskIndex++;
            
            const userTasks = db.tasks.filter(t => t.user_id === currentUser.id);
            const taskOptions = userTasks.map(task => {
                return `<option value="${task.task_id}">${task.task_name}</option>`;
            }).join('');
            
            const taskHtml = `
                <div class="task-item" id="weeklyTask_${taskIndex}">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <h4>Công việc ${taskIndex + 1}</h4>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeWeeklyTask(${taskIndex})">Xóa</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>Chọn công việc *</label>
                            <select class="form-control" name="task_id_${taskIndex}" required>
                                <option value="">Chọn công việc</option>
                                ${taskOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Số giờ làm trong tuần *</label>
                            <input type="number" class="form-control" name="duration_week_${taskIndex}" min="0" step="0.5" required>
                        </div>
                        <div class="form-group">
                            <label>Tiến độ (%)</label>
                            <input type="number" class="form-control" name="progress_pct_${taskIndex}" min="0" max="100" value="0">
                        </div>
                        <div class="form-group">
                            <label>Ghi chú</label>
                            <input type="text" class="form-control" name="week_note_${taskIndex}">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', taskHtml);
        }

        function removeWeeklyTask(index) {
            const task = document.getElementById(`weeklyTask_${index}`);
            if (task) {
                task.remove();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Form submissions
        document.getElementById('projectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const projectId = document.getElementById('projectId').value;
                const formData = {
                    proj_name: document.getElementById('projName').value,
                    customer: document.getElementById('customer').value,
                    description: document.getElementById('description').value,
                    start_date: document.getElementById('startDate').value || null,
                    end_date: document.getElementById('endDate').value || null,
                    status: document.getElementById('status').value
                };
                
                if (projectId) {
                    const { error } = await supabase
                        .from('projects')
                        .update(formData)
                        .eq('project_id', projectId);
                    
                    if (error) throw error;
                } else {
                    const year = new Date().getFullYear().toString().slice(-2);
                    const seq = (db.projects.length + 1).toString().padStart(3, '0');
                    const newProjectId = `${year}_${seq}`;
                    
                    const { error } = await supabase
                        .from('projects')
                        .insert({
                            project_id: newProjectId,
                            ...formData,
                            created_by: currentUser.id
                        });
                    
                    if (error) throw error;
                }
                
                closeModal('projectModal');
                await loadProjects();
                populateFilters();
                showSuccess('Lưu dự án thành công!');
            } catch (error) {
                console.error('Error saving project:', error);
                alert('Lỗi lưu dự án: ' + error.message);
            }
        });

        document.getElementById('taskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const taskId = document.getElementById('taskId').value;
                const formData = {
                    project_id: document.getElementById('taskProjectId').value,
                    user_id: document.getElementById('taskUserId').value,
                    task_name: document.getElementById('taskName').value,
                    description: document.getElementById('taskDescription').value,
                    start_date: document.getElementById('taskStartDate').value || null,
                    end_date: document.getElementById('taskEndDate').value || null,
                    total_duration: parseFloat(document.getElementById('totalDuration').value) || 0,
                    progress_pct: parseInt(document.getElementById('progressPct').value) || 0,
                    status: document.getElementById('taskStatus').value
                };
                
                if (taskId) {
                    const { error } = await supabase
                        .from('tasks')
                        .update(formData)
                        .eq('task_id', taskId);
                    
                    if (error) throw error;
                } else {
                    const user = db.users.find(u => u.id === formData.user_id);
                    const taskSeq = (db.tasks.filter(t => t.project_id === formData.project_id).length + 1).toString().padStart(4, '0');
                    const newTaskId = `${formData.project_id}_${user?.code_id || '00'}_${taskSeq}`;
                    
                    const { error } = await supabase
                        .from('tasks')
                        .insert({
                            task_id: newTaskId,
                            ...formData,
                            created_by: currentUser.id
                        });
                    
                    if (error) throw error;
                }
                
                closeModal('taskModal');
                await loadTasks();
                showSuccess('Lưu công việc thành công!');
            } catch (error) {
                console.error('Error saving task:', error);
                alert('Lỗi lưu công việc: ' + error.message);
            }
        });

        document.getElementById('weeklyReportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const reportData = {
                    user_id: currentUser.id,
                    year: parseInt(document.getElementById('reportYear').value),
                    iso_week: parseInt(document.getElementById('isoWeek').value),
                    report_note: document.getElementById('reportNote').value,
                    status: 'draft',
                    created_by: currentUser.id
                };
                
                const { data: report, error: reportError } = await supabase
                    .from('weekly_reports')
                    .insert(reportData)
                    .select()
                    .single();
                
                if (reportError) throw reportError;
                
                const taskItems = document.querySelectorAll('#weeklyTasksList .task-item');
                const tasks = [];
                
                for (let i = 0; i < taskItems.length; i++) {
                    const item = taskItems[i];
                    const taskIdInput = item.querySelector(`[name^="task_id_"]`);
                    if (taskIdInput && taskIdInput.value) {
                        tasks.push({
                            report_id: report.report_id,
                            task_id: taskIdInput.value,
                            duration_week: parseFloat(item.querySelector(`[name^="duration_week_"]`).value) || 0,
                            progress_pct: parseInt(item.querySelector(`[name^="progress_pct_"]`).value) || 0,
                            week_note: item.querySelector(`[name^="week_note_"]`).value
                        });
                    }
                }
                
                if (tasks.length > 0) {
                    const { error: tasksError } = await supabase
                        .from('weekly_report_tasks')
                        .insert(tasks);
                    
                    if (tasksError) throw tasksError;
                }
                
                closeModal('weeklyReportModal');
                await loadWeeklyReports();
                showSuccess('Báo cáo tuần đã được lưu thành công!');
            } catch (error) {
                console.error('Error saving weekly report:', error);
                alert('Lỗi lưu báo cáo: ' + error.message);
            }
        });

        // Check permissions based on role
        function checkPermission(action, resource, item = null) {
            const role = currentUser?.role || 'staff';
            
            // Admin has all permissions
            if (role === 'admin') return true;
            
            switch (resource) {
                case 'project':
                    switch (action) {
                        case 'create':
                            return role === 'pm';
                        case 'update':
                            if (role === 'pm') {
                                // PM can update projects they manage or created
                                return !item || item.project_manager === currentUser.id || 
                                       item.created_by === currentUser.id;
                            }
                            return false;
                        case 'delete':
                            return false; // Only admin
                        default:
                            return true; // View
                    }
                    
                case 'task':
                    switch (action) {
                        case 'create':
                            return true; // All can create
                        case 'update':
                            if (role === 'pm') return true;
                            if (role === 'staff') {
                                // Staff can only update their own tasks
                                return item && (item.user_id === currentUser.id || 
                                              item.created_by === currentUser.id);
                            }
                            return false;
                        case 'delete':
                            if (role === 'pm') {
                                return !item || item.created_by === currentUser.id;
                            }
                            return false;
                        default:
                            return true; // View
                    }
                    
                case 'report':
                    switch (action) {
                        case 'create':
                            return true;
                        case 'update':
                            if (role === 'pm') return true;
                            // Users can only update their own draft reports
                            return item && item.user_id === currentUser.id && 
                                   item.status === 'draft';
                        case 'delete':
                            // Users can only delete their own draft reports
                            return item && item.user_id === currentUser.id && 
                                   item.status === 'draft';
                        case 'approve':
                        case 'reject':
                            return role === 'pm';
                        default:
                            return true; // View
                    }
                    
                default:
                    return false;
            }
        }

        // Helper functions
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        function getStatusBadge(status) {
            const statusMap = {
                // Project status
                'planning': '<span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Lập kế hoạch</span>',
                'active': '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Đang hoạt động</span>',
                'completed': '<span style="background: #17a2b8; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Đã hoàn thành</span>',
                'paused': '<span style="background: #ffc107; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Tạm dừng</span>',
                'cancelled': '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Đã hủy</span>',
                // Task status
                'pending': '<span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Chờ xử lý</span>',
                'in_progress': '<span style="background: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Đang thực hiện</span>',
                'review': '<span style="background: #e83e8c; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Đang review</span>',
                // Report status
                'draft': '<span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Nháp</span>',
                'submitted': '<span style="background: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Đã nộp</span>',
                'approved': '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Đã duyệt</span>',
                'rejected': '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Từ chối</span>'
            };
            return statusMap[status] || status;
        }

        function getISOWeek(date) {
            const tempDate = new Date(date.getTime());
            tempDate.setHours(0, 0, 0, 0);
            tempDate.setDate(tempDate.getDate() + 3 - (tempDate.getDay() + 6) % 7);
            const week1 = new Date(tempDate.getFullYear(), 0, 4);
            return 1 + Math.round(((tempDate.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '9999';
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        function populateFilters() {
            const projectFilters = ['taskProjectFilter'];
            projectFilters.forEach(filterId => {
                const select = document.getElementById(filterId);
                if (select) {
                    select.innerHTML = '<option value="">Tất cả dự án</option>';
                    db.projects.forEach(project => {
                        select.innerHTML += `<option value="${project.project_id}">${project.proj_name}</option>`;
                    });
                }
            });
            
            const userFilter = document.getElementById('taskUserFilter');
            if (userFilter) {
                userFilter.innerHTML = '<option value="">Tất cả người dùng</option>';
                db.users.forEach(user => {
                    userFilter.innerHTML += `<option value="${user.id}">${user.full_name}</option>`;
                });
            }
        }

        function populateWeekFilter() {
            const weekFilter = document.getElementById('reportWeekFilter');
            if (weekFilter) {
                weekFilter.innerHTML = '<option value="">Tất cả các tuần</option>';
                for (let i = 1; i <= 53; i++) {
                    weekFilter.innerHTML += `<option value="${i}">Tuần ${i}</option>`;
                }
            }
        }

        // Modal close when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
