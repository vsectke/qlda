<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý Dự án & Báo cáo - Supabase</title>
    
    <!-- Supabase JS v2 UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .login-box h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .google-login-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: white;
            border: 2px solid #4285f4;
            color: #4285f4;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        .google-login-btn:hover {
            background: #4285f4;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(66, 133, 244, 0.3);
        }
        
        .google-login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .google-icon {
            width: 20px;
            height: 20px;
        }
        
        /* Main App Styles */
        .app-container {
            display: none;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
            border: 2px solid white;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* Autocomplete Styles */
        .autocomplete-wrapper {
            position: relative;
        }
        
        .autocomplete-input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .autocomplete-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .autocomplete-suggestion {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .autocomplete-suggestion:hover,
        .autocomplete-suggestion.selected {
            background-color: #f0f0f0;
        }
        
        .autocomplete-suggestion strong {
            color: #667eea;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #333;
        }
        
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        
        .close:hover {
            color: #000;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .weekly-report-tasks {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .task-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #fcc;
        }
        
        .success {
            background: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #cfc;
        }
        
        .info {
            background: #e3f2fd;
            color: #1976d2;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #bbdefb;
        }
        
        .no-permission {
            text-align: center;
            padding: 10px;
            color: #999;
            font-size: 12px;
        }
        
        .project-info {
            background: #f0f4ff;
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 13px;
            color: #555;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h1>Hệ thống Quản lý Dự án</h1>
            <p style="margin-bottom: 30px; color: #666;">Vui lòng đăng nhập để tiếp tục</p>
            <button class="google-login-btn" onclick="loginWithGoogle()">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span class="btn-text">Đăng nhập với Google</span>
            </button>
            <div id="loginError" class="error" style="display: none; margin-top: 20px;"></div>
            <div id="loginInfo" class="info" style="display: none; margin-top: 20px;"></div>
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <p style="font-size: 12px; color: #999;">
                    Lưu ý: Bạn cần có tài khoản Google để đăng nhập.<br>
                    Lần đầu đăng nhập sẽ tự động tạo tài khoản trong hệ thống.
                </p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="app-container">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>Hệ thống Quản lý Dự án & Báo cáo Tuần</h1>
                <div class="user-info">
                    <div>
                        <img id="userAvatar" class="user-avatar" src="" alt="">
                        <span id="userName">Đang tải...</span> | 
                        <span id="userRole">...</span> | 
                        <span id="userCode">...</span>
                    </div>
                    <button class="btn btn-secondary" onclick="logout()">Đăng xuất</button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showSection('projects')">Dự án</button>
                <button class="tab" onclick="showSection('tasks')">Công việc</button>
                <button class="tab" onclick="showSection('weekly-reports')">Báo cáo tuần</button>
                <button class="tab" onclick="showSection('activity')">Hoạt động tuần</button>
                <button class="tab" onclick="showSection('progress')">Tiến độ dự án</button>
            </div>

            <!-- Main Content -->
            <div class="content">
                <!-- Projects Section -->
                <div id="projects" class="section active">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Quản lý Dự án</h2>
                        <button class="btn btn-primary" onclick="showProjectModal()">+ Thêm dự án mới</button>
                    </div>
                    <div class="filters">
                        <div class="filter-group">
                            <label>Tìm kiếm dự án:</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" class="autocomplete-input" id="projectSearch" placeholder="Nhập tên dự án hoặc khách hàng..." onkeyup="searchProjects(this.value)">
                                <div class="autocomplete-suggestions" id="projectSearchSuggestions"></div>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="projectsTable">
                            <thead>
                                <tr>
                                    <th>Mã dự án</th>
                                    <th>Tên dự án</th>
                                    <th>Khách hàng</th>
                                    <th>Mô tả</th>
                                    <th>Ngày bắt đầu</th>
                                    <th>Ngày kết thúc</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="8" class="loading"><div class="loading-spinner"></div> Đang tải dữ liệu...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tasks Section -->
                <div id="tasks" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Quản lý Công việc</h2>
                        <button class="btn btn-primary" onclick="showTaskModal()">+ Thêm công việc mới</button>
                    </div>
                    <div class="filters">
                        <div class="filter-group">
                            <label>Tìm kiếm công việc:</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" class="autocomplete-input" id="taskSearch" placeholder="Nhập tên công việc..." onkeyup="searchTasks(this.value)">
                                <div class="autocomplete-suggestions" id="taskSearchSuggestions"></div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label>Lọc theo dự án:</label>
                            <select class="form-control" id="taskProjectFilter" onchange="loadTasks()">
                                <option value="">Tất cả dự án</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Lọc theo người thực hiện:</label>
                            <select class="form-control" id="taskUserFilter" onchange="loadTasks()">
                                <option value="">Tất cả người dùng</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="tasksTable">
                            <thead>
                                <tr>
                                    <th>Mã công việc</th>
                                    <th>Dự án</th>
                                    <th>Người thực hiện</th>
                                    <th>Tên công việc</th>
                                    <th>Mô tả</th>
                                    <th>Ngày bắt đầu</th>
                                    <th>Ngày kết thúc</th>
                                    <th>Tiến độ (%)</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="10" class="loading"><div class="loading-spinner"></div> Đang tải dữ liệu...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Weekly Reports Section -->
                <div id="weekly-reports" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Báo cáo Tuần</h2>
                        <button class="btn btn-primary" onclick="showWeeklyReportModal()">+ Tạo báo cáo tuần</button>
                    </div>
                    <div class="filters">
                        <div class="filter-group">
                            <label>Năm:</label>
                            <select class="form-control" id="reportYearFilter" onchange="loadWeeklyReports()">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Tuần:</label>
                            <select class="form-control" id="reportWeekFilter" onchange="loadWeeklyReports()">
                                <option value="">Tất cả các tuần</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="weeklyReportsTable">
                            <thead>
                                <tr>
                                    <th>Mã báo cáo</th>
                                    <th>Người tạo</th>
                                    <th>Tuần</th>
                                    <th>Năm</th>
                                    <th>Ghi chú</th>
                                    <th>Trạng thái</th>
                                    <th>Ngày nộp</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="8" class="loading"><div class="loading-spinner"></div> Đang tải dữ liệu...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- User Activity Section -->
                <div id="activity" class="section">
                    <h2>Hoạt động Tuần của Nhân viên</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label>Tìm kiếm nhân viên:</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" class="autocomplete-input" id="userActivitySearch" placeholder="Nhập tên nhân viên..." onkeyup="searchUserActivity(this.value)">
                                <div class="autocomplete-suggestions" id="userActivitySuggestions"></div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label>Năm:</label>
                            <select class="form-control" id="activityYearFilter" onchange="loadActivity()">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Từ tuần:</label>
                            <input type="number" class="form-control" id="activityWeekFrom" min="1" max="53" value="1" onchange="loadActivity()">
                        </div>
                        <div class="filter-group">
                            <label>Đến tuần:</label>
                            <input type="number" class="form-control" id="activityWeekTo" min="1" max="53" value="53" onchange="loadActivity()">
                        </div>
                        <div class="filter-group">
                            <label>Dự án:</label>
                            <select class="form-control" id="activityProjectFilter" onchange="loadActivity()">
                                <option value="">Tất cả dự án</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="activityTable">
                            <thead>
                                <tr>
                                    <th>Năm</th>
                                    <th>Tuần</th>
                                    <th>Nhân viên</th>
                                    <th>Mã NV</th>
                                    <th>Dự án</th>
                                    <th>Khách hàng</th>
                                    <th>Số công việc</th>
                                    <th>Giờ làm</th>
                                    <th>Tiến độ TB (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="9" class="loading"><div class="loading-spinner"></div> Đang tải dữ liệu...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Project Progress Section -->
                <div id="progress" class="section">
                    <h2>Tiến độ Tổng thể Dự án</h2>
                    <div class="stats-grid" id="progressStats">
                        <!-- Stats cards will be inserted here -->
                    </div>
                    <div class="table-container">
                        <table id="progressTable">
                            <thead>
                                <tr>
                                    <th>Mã dự án</th>
                                    <th>Tên dự án</th>
                                    <th>Khách hàng</th>
                                    <th>Ngày bắt đầu</th>
                                    <th>Ngày kết thúc</th>
                                    <th>Trạng thái</th>
                                    <th>Tổng công việc</th>
                                    <th>Đã hoàn thành</th>
                                    <th>Tiến độ (%)</th>
                                    <th>Giờ ước tính</th>
                                    <th>Giờ đã làm</th>
                                    <th>Số thành viên</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="12" class="loading"><div class="loading-spinner"></div> Đang tải dữ liệu...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="projectModalTitle">Thêm Dự án mới</h2>
                <span class="close" onclick="closeModal('projectModal')">&times;</span>
            </div>
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <div class="form-group">
                    <label>Tên dự án *</label>
                    <input type="text" class="form-control" id="projName" required>
                </div>
                <div class="form-group">
                    <label>Khách hàng</label>
                    <input type="text" class="form-control" id="customer">
                </div>
                <div class="form-group">
                    <label>Mô tả</label>
                    <textarea class="form-control" id="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Ngày bắt đầu</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="form-group">
                    <label>Ngày kết thúc</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="form-group">
                    <label>Trạng thái</label>
                    <select class="form-control" id="status">
                        <option value="active">Đang hoạt động</option>
                        <option value="completed">Đã hoàn thành</option>
                        <option value="paused">Tạm dừng</option>
                    </select>
                </div>
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Lưu</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('projectModal')">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="taskModalTitle">Thêm Công việc mới</h2>
                <span class="close" onclick="closeModal('taskModal')">&times;</span>
            </div>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <div class="form-group">
                    <label>Dự án *</label>
                    <select class="form-control" id="taskProjectId" required>
                        <option value="">Chọn dự án</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Người thực hiện *</label>
                    <select class="form-control" id="taskUserId" required>
                        <option value="">Chọn người thực hiện</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tên công việc *</label>
                    <input type="text" class="form-control" id="taskName" required>
                </div>
                <div class="form-group">
                    <label>Mô tả</label>
                    <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Ngày bắt đầu</label>
                    <input type="date" class="form-control" id="taskStartDate">
                </div>
                <div class="form-group">
                    <label>Ngày kết thúc</label>
                    <input type="date" class="form-control" id="taskEndDate">
                </div>
                <div class="form-group">
                    <label>Thời gian ước tính (giờ)</label>
                    <input type="number" class="form-control" id="totalDuration" min="0" step="0.5">
                </div>
                <div class="form-group">
                    <label>Tiến độ (%)</label>
                    <input type="number" class="form-control" id="progressPct" min="0" max="100" value="0">
                </div>
                <div class="form-group">
                    <label>Trạng thái</label>
                    <select class="form-control" id="taskStatus">
                        <option value="pending">Chờ xử lý</option>
                        <option value="in_progress">Đang thực hiện</option>
                        <option value="completed">Đã hoàn thành</option>
                    </select>
                </div>
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Lưu</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('taskModal')">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Weekly Report Modal -->
    <div id="weeklyReportModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="weeklyReportModalTitle">Tạo/Sửa Báo cáo Tuần</h2>
                <span class="close" onclick="closeModal('weeklyReportModal')">&times;</span>
            </div>
            <form id="weeklyReportForm">
                <input type="hidden" id="wReportId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Năm *</label>
                        <input type="number" class="form-control" id="reportYear" min="2024" max="2030" required>
                    </div>
                    <div class="form-group">
                        <label>Tuần ISO *</label>
                        <input type="number" class="form-control" id="isoWeek" min="1" max="53" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ghi chú báo cáo</label>
                    <textarea class="form-control" id="reportNote" rows="3"></textarea>
                </div>
                
                <h3 style="margin-top: 30px; margin-bottom: 15px;">Chi tiết công việc trong tuần</h3>
                <div id="weeklyTasksContainer">
                    <button type="button" class="btn btn-secondary" onclick="addWeeklyTask()">+ Thêm công việc</button>
                    <div id="weeklyTasksList" style="margin-top: 15px;">
                        <!-- Tasks will be dynamically added here -->
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <button type="submit" class="btn btn-primary">Lưu báo cáo</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('weeklyReportModal')">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // SUPABASE CONFIGURATION
        // ========================================
        // THAY ĐỔI THÔNG TIN NÀY VỚI THÔNG TIN TỪ SUPABASE PROJECT CỦA BẠN
        const SUPABASE_URL = 'https://vtuytabzqlxjbfpeniit.supabase.co'; // Thay bằng URL từ Supabase
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0dXl0YWJ6cWx4amJmcGVuaWl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzY2NDksImV4cCI6MjA2OTk1MjY0OX0.NVSpMhIn8GVqKfbOHglkoZnCUDyS4gFR0xyHIAoxNZ8'; // Thay bằng anon key từ Supabase
   // Kiểm tra cấu hình
        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
            alert('⚠️ Vui lòng cấu hình SUPABASE_URL và SUPABASE_ANON_KEY trong file!\n\nHướng dẫn:\n1. Vào Supabase Dashboard\n2. Settings → API\n3. Copy Project URL và anon key\n4. Thay thế vào file này');
        }
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ========================================
        // GLOBAL VARIABLES
        // ========================================
        let currentUser = null;
        let db = {
            projects: [],
            tasks: [],
            users: [],
            weeklyReports: [],
            activities: []
        };

        // ========================================
        // AUTHENTICATION FUNCTIONS
        // ========================================
        
        // Initialize - Check authentication status
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing app...');
            
            // Check if user is already logged in
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (error) {
                console.error('Session error:', error);
                showError('loginError', 'Lỗi kiểm tra phiên đăng nhập: ' + error.message);
                showLoginPage();
                return;
            }
            
            if (session) {
                console.log('Existing session found:', session);
                await handleSuccessfulLogin(session);
            } else {
                console.log('No existing session');
                showLoginPage();
            }
            
            // Listen for auth state changes
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth state changed:', event, session);
                
                if (event === 'SIGNED_IN' && session) {
                    await handleSuccessfulLogin(session);
                } else if (event === 'SIGNED_OUT') {
                    showLoginPage();
                } else if (event === 'TOKEN_REFRESHED') {
                    console.log('Token refreshed');
                } else if (event === 'USER_UPDATED') {
                    console.log('User updated');
                    if (session) {
                        await handleSuccessfulLogin(session);
                    }
                }
            });
        });

        // Login with Google
        async function loginWithGoogle() {
            try {
                // Show loading state
                const loginBtn = document.querySelector('.google-login-btn');
                const btnText = loginBtn.querySelector('.btn-text');
                loginBtn.disabled = true;
                btnText.textContent = 'Đang chuyển hướng...';
                
                // Clear any previous errors
                document.getElementById('loginError').style.display = 'none';
                
                // Show info message
                showInfo('loginInfo', 'Đang chuyển hướng đến Google để đăng nhập...');
                
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + window.location.pathname,
                        queryParams: {
                            access_type: 'offline',
                            prompt: 'consent'
                        }
                    }
                });
                
                if (error) throw error;
                
                console.log('OAuth redirect initiated:', data);
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Reset button state
                const loginBtn = document.querySelector('.google-login-btn');
                const btnText = loginBtn.querySelector('.btn-text');
                loginBtn.disabled = false;
                btnText.textContent = 'Đăng nhập với Google';
                
                // Hide info and show error
                document.getElementById('loginInfo').style.display = 'none';
                showError('loginError', 'Lỗi đăng nhập: ' + error.message);
            }
        }

        // Handle successful login
        async function handleSuccessfulLogin(session) {
            try {
                console.log('Handling successful login for user:', session.user.email);
                
                // First check if profile exists
                const { data: existingProfile, error: checkError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', session.user.id)
                    .maybeSingle();
                
                if (checkError && checkError.code !== 'PGRST116') {
                    console.error('Error checking profile:', checkError);
                }
                
                let userProfile = existingProfile;
                
                // If no profile exists, create one
                if (!userProfile) {
                    console.log('Creating new user profile...');
                    
                    const profileData = {
                        id: session.user.id,
                        email: session.user.email,
                        full_name: session.user.user_metadata?.full_name || 
                                  session.user.user_metadata?.name || 
                                  session.user.email.split('@')[0],
                        avatar_url: session.user.user_metadata?.avatar_url || 
                                   session.user.user_metadata?.picture || ''
                    };
                    
                    const { data: newProfile, error: insertError } = await supabase
                        .from('user_profiles')
                        .insert(profileData)
                        .select()
                        .single();
                    
                    if (insertError) {
                        console.error('Error creating profile:', insertError);
                        // Try to get profile again in case it was created by trigger
                        const { data: retriedProfile } = await supabase
                            .from('user_profiles')
                            .select('*')
                            .eq('id', session.user.id)
                            .maybeSingle();
                        
                        userProfile = retriedProfile;
                    } else {
                        userProfile = newProfile;
                        console.log('Profile created successfully');
                    }
                }
                
                // Update profile with latest Google info if needed
                if (userProfile && session.user.user_metadata) {
                    const updates = {};
                    const latestName = session.user.user_metadata.full_name || session.user.user_metadata.name;
                    const latestAvatar = session.user.user_metadata.avatar_url || session.user.user_metadata.picture;
                    
                    if (latestName && latestName !== userProfile.full_name) {
                        updates.full_name = latestName;
                    }
                    if (latestAvatar && latestAvatar !== userProfile.avatar_url) {
                        updates.avatar_url = latestAvatar;
                    }
                    
                    if (Object.keys(updates).length > 0) {
                        console.log('Updating profile with latest info:', updates);
                        await supabase
                            .from('user_profiles')
                            .update(updates)
                            .eq('id', session.user.id);
                    }
                }
                
                // Set current user with profile data
                currentUser = {
                    id: session.user.id,
                    email: session.user.email,
                    displayName: userProfile?.full_name || 
                                session.user.user_metadata?.full_name || 
                                session.user.user_metadata?.name || 
                                session.user.email.split('@')[0],
                    photoURL: userProfile?.avatar_url || 
                             session.user.user_metadata?.avatar_url || 
                             session.user.user_metadata?.picture || '',
                    role: userProfile?.role || 'staff',
                    code_id: userProfile?.code_id || null
                };
                
                console.log('User logged in successfully:', currentUser);
                showMainApp();
                
            } catch (error) {
                console.error('Error handling login:', error);
                // Still allow login even if profile setup fails
                currentUser = {
                    id: session.user.id,
                    email: session.user.email,
                    displayName: session.user.user_metadata?.full_name || 
                                session.user.user_metadata?.name || 
                                session.user.email.split('@')[0],
                    photoURL: session.user.user_metadata?.avatar_url || 
                             session.user.user_metadata?.picture || '',
                    role: 'staff',
                    code_id: null
                };
                showMainApp();
            }
        }

        // Logout
        async function logout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                currentUser = null;
                db = {
                    projects: [],
                    tasks: [],
                    users: [],
                    weeklyReports: [],
                    activities: []
                };
                
                console.log('User logged out successfully');
                showLoginPage();
            } catch (error) {
                console.error('Logout error:', error);
                alert('Lỗi đăng xuất: ' + error.message);
            }
        }

        // Show login page
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            // Reset login button state
            const loginBtn = document.querySelector('.google-login-btn');
            if (loginBtn) {
                loginBtn.disabled = false;
                const btnText = loginBtn.querySelector('.btn-text');
                if (btnText) {
                    btnText.textContent = 'Đăng nhập với Google';
                }
            }
        }

        // Show main app
        function showMainApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.querySelector('.app-container').style.display = 'block';
            updateUserInfo();
            loadInitialData();
        }

        // Update user info in UI
        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.displayName;
                document.getElementById('userRole').textContent = getRoleDisplay(currentUser.role);
                document.getElementById('userCode').textContent = `Mã: ${currentUser.code_id || 'N/A'}`;
                
                const avatar = document.getElementById('userAvatar');
                avatar.src = currentUser.photoURL || 
                    `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName)}&background=667eea&color=fff`;
                avatar.onerror = function() {
                    this.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName)}&background=667eea&color=fff`;
                };
            }
        }

        function getRoleDisplay(role) {
            const roleMap = {
                'admin': 'Quản trị viên',
                'pm': 'Quản lý dự án',
                'staff': 'Nhân viên'
            };
            return roleMap[role] || role;
        }

        // ========================================
        // TAB NAVIGATION
        // ========================================
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load data for the section
            switch(sectionId) {
                case 'projects':
                    loadProjects();
                    break;
                case 'tasks':
                    loadTasks();
                    break;
                case 'weekly-reports':
                    loadWeeklyReports();
                    break;
                case 'activity':
                    loadActivity();
                    break;
                case 'progress':
                    loadProgress();
                    break;
            }
        }

        // ========================================
        // INITIAL DATA LOADING
        // ========================================
        async function loadInitialData() {
            try {
                // Load all users for dropdowns
                const { data: users, error: usersError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .order('full_name');
                
                if (usersError) throw usersError;
                db.users = users;
                
                // Load projects
                await loadProjects();
                
                // Populate filters
                populateFilters();
                populateWeekFilter();
            } catch (error) {
                console.error('Error loading initial data:', error);
                alert('Lỗi tải dữ liệu: ' + error.message);
            }
        }

        // ========================================
        // PROJECTS CRUD
        // ========================================
        async function loadProjects() {
            try {
                const tbody = document.querySelector('#projectsTable tbody');
                tbody.innerHTML = '<tr><td colspan="8" class="loading">Đang tải dữ liệu...</td></tr>';
                
                const { data: projects, error } = await supabase
                    .from('projects')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                db.projects = projects;
                displayProjects(projects);
            } catch (error) {
                console.error('Error loading projects:', error);
                const tbody = document.querySelector('#projectsTable tbody');
                tbody.innerHTML = `<tr><td colspan="8" class="error">Lỗi tải dữ liệu: ${error.message}</td></tr>`;
            }
        }

        function displayProjects(projects) {
            const tbody = document.querySelector('#projectsTable tbody');
            
            if (projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Không có dữ liệu</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            projects.forEach(project => {
                tbody.innerHTML += `
                    <tr>
                        <td>${project.project_id}</td>
                        <td>${project.proj_name}</td>
                        <td>${project.customer || '-'}</td>
                        <td>${project.description || '-'}</td>
                        <td>${formatDate(project.start_date)}</td>
                        <td>${formatDate(project.end_date)}</td>
                        <td>${getStatusBadge(project.status)}</td>
                        <td>
                            <div class="actions">
                                ${canEdit('project', project) ? `
                                    <button class="btn btn-sm btn-primary" onclick="editProject('${project.project_id}')">Sửa</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteProject('${project.project_id}')">Xóa</button>
                                ` : '<span class="no-permission">Không có quyền</span>'}
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        function showProjectModal(projectId = null) {
            const modal = document.getElementById('projectModal');
            const title = document.getElementById('projectModalTitle');
            const form = document.getElementById('projectForm');
            
            if (projectId) {
                title.textContent = 'Sửa Dự án';
                const project = db.projects.find(p => p.project_id === projectId);
                if (project) {
                    document.getElementById('projectId').value = project.project_id;
                    document.getElementById('projName').value = project.proj_name;
                    document.getElementById('customer').value = project.customer || '';
                    document.getElementById('description').value = project.description || '';
                    document.getElementById('startDate').value = project.start_date || '';
                    document.getElementById('endDate').value = project.end_date || '';
                    document.getElementById('status').value = project.status;
                }
            } else {
                title.textContent = 'Thêm Dự án mới';
                form.reset();
            }
            
            modal.style.display = 'block';
        }

        function editProject(projectId) {
            showProjectModal(projectId);
        }

        async function deleteProject(projectId) {
            if (!confirm('Bạn có chắc muốn xóa dự án này?')) return;
            
            try {
                const { error } = await supabase
                    .from('projects')
                    .delete()
                    .eq('project_id', projectId);
                
                if (error) throw error;
                
                await loadProjects();
                showSuccess('Xóa dự án thành công!');
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Lỗi xóa dự án: ' + error.message);
            }
        }

        // ========================================
        // TASKS CRUD
        // ========================================
        async function loadTasks() {
            try {
                const tbody = document.querySelector('#tasksTable tbody');
                tbody.innerHTML = '<tr><td colspan="10" class="loading">Đang tải dữ liệu...</td></tr>';
                
                let query = supabase
                    .from('tasks')
                    .select(`
                        *,
                        project:projects(proj_name),
                        user:user_profiles(full_name)
                    `)
                    .order('created_at', { ascending: false });
                
                // Apply filters
                const projectFilter = document.getElementById('taskProjectFilter').value;
                const userFilter = document.getElementById('taskUserFilter').value;
                
                if (projectFilter) {
                    query = query.eq('project_id', projectFilter);
                }
                if (userFilter) {
                    query = query.eq('user_id', userFilter);
                }
                
                const { data: tasks, error } = await query;
                
                if (error) throw error;
                
                db.tasks = tasks;
                displayTasks(tasks);
            } catch (error) {
                console.error('Error loading tasks:', error);
                const tbody = document.querySelector('#tasksTable tbody');
                tbody.innerHTML = `<tr><td colspan="10" class="error">Lỗi tải dữ liệu: ${error.message}</td></tr>`;
            }
        }

        function displayTasks(tasks) {
            const tbody = document.querySelector('#tasksTable tbody');
            
            if (tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Không có dữ liệu</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            tasks.forEach(task => {
                tbody.innerHTML += `
                    <tr>
                        <td>${task.task_id}</td>
                        <td>${task.project?.proj_name || '-'}</td>
                        <td>${task.user?.full_name || '-'}</td>
                        <td>${task.task_name}</td>
                        <td>${task.description || '-'}</td>
                        <td>${formatDate(task.start_date)}</td>
                        <td>${formatDate(task.end_date)}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${task.progress_pct}%"></div>
                            </div>
                            ${task.progress_pct}%
                        </td>
                        <td>${getStatusBadge(task.status)}</td>
                        <td>
                            <div class="actions">
                                ${canEdit('task', task) ? `
                                    <button class="btn btn-sm btn-primary" onclick="editTask('${task.task_id}')">Sửa</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteTask('${task.task_id}')">Xóa</button>
                                ` : '<span class="no-permission">Không có quyền</span>'}
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        function showTaskModal(taskId = null) {
            const modal = document.getElementById('taskModal');
            const title = document.getElementById('taskModalTitle');
            const form = document.getElementById('taskForm');
            
            // Populate dropdowns
            populateTaskDropdowns();
            
            if (taskId) {
                title.textContent = 'Sửa Công việc';
                const task = db.tasks.find(t => t.task_id === taskId);
                if (task) {
                    document.getElementById('taskId').value = task.task_id;
                    document.getElementById('taskProjectId').value = task.project_id;
                    document.getElementById('taskUserId').value = task.user_id;
                    document.getElementById('taskName').value = task.task_name;
                    document.getElementById('taskDescription').value = task.description || '';
                    document.getElementById('taskStartDate').value = task.start_date || '';
                    document.getElementById('taskEndDate').value = task.end_date || '';
                    document.getElementById('totalDuration').value = task.total_duration || '';
                    document.getElementById('progressPct').value = task.progress_pct || 0;
                    document.getElementById('taskStatus').value = task.status;
                }
            } else {
                title.textContent = 'Thêm Công việc mới';
                form.reset();
            }
            
            modal.style.display = 'block';
        }

        function populateTaskDropdowns() {
            const projectSelect = document.getElementById('taskProjectId');
            projectSelect.innerHTML = '<option value="">Chọn dự án</option>';
            db.projects.forEach(project => {
                projectSelect.innerHTML += `<option value="${project.project_id}">${project.proj_name}</option>`;
            });
            
            const userSelect = document.getElementById('taskUserId');
            userSelect.innerHTML = '<option value="">Chọn người thực hiện</option>';
            db.users.forEach(user => {
                userSelect.innerHTML += `<option value="${user.id}">${user.full_name}</option>`;
            });
        }

        function editTask(taskId) {
            showTaskModal(taskId);
        }

        async function deleteTask(taskId) {
            if (!confirm('Bạn có chắc muốn xóa công việc này?')) return;
            
            try {
                const { error } = await supabase
                    .from('tasks')
                    .delete()
                    .eq('task_id', taskId);
                
                if (error) throw error;
                
                await loadTasks();
                showSuccess('Xóa công việc thành công!');
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Lỗi xóa công việc: ' + error.message);
            }
        }

        // ========================================
        // WEEKLY REPORTS
        // ========================================
        async function loadWeeklyReports() {
            try {
                const tbody = document.querySelector('#weeklyReportsTable tbody');
                tbody.innerHTML = '<tr><td colspan="8" class="loading">Đang tải dữ liệu...</td></tr>';
                
                let query = supabase
                    .from('weekly_reports')
                    .select(`
                        *,
                        user:user_profiles(full_name)
                    `)
                    .order('year', { ascending: false })
                    .order('iso_week', { ascending: false });
                
                // Apply filters
                const yearFilter = document.getElementById('reportYearFilter').value;
                const weekFilter = document.getElementById('reportWeekFilter').value;
                
                if (yearFilter) {
                    query = query.eq('year', parseInt(yearFilter));
                }
                if (weekFilter) {
                    query = query.eq('iso_week', parseInt(weekFilter));
                }
                
                const { data: reports, error } = await query;
                
                if (error) throw error;
                
                displayWeeklyReports(reports);
            } catch (error) {
                console.error('Error loading weekly reports:', error);
                const tbody = document.querySelector('#weeklyReportsTable tbody');
                tbody.innerHTML = `<tr><td colspan="8" class="error">Lỗi tải dữ liệu: ${error.message}</td></tr>`;
            }
        }

        function displayWeeklyReports(reports) {
            const tbody = document.querySelector('#weeklyReportsTable tbody');
            
            if (reports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Không có dữ liệu</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            reports.forEach(report => {
                tbody.innerHTML += `
                    <tr>
                        <td>${report.report_id}</td>
                        <td>${report.user?.full_name || '-'}</td>
                        <td>${report.iso_week}</td>
                        <td>${report.year}</td>
                        <td>${report.report_note || '-'}</td>
                        <td>${getStatusBadge(report.status)}</td>
                        <td>${formatDate(report.submitted_at)}</td>
                        <td>
                            <div class="actions">
                                ${canEdit('report', report) ? `
                                    <button class="btn btn-sm btn-primary" onclick="editWeeklyReport(${report.report_id})">Sửa</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteWeeklyReport(${report.report_id})">Xóa</button>
                                ` : '<span class="no-permission">Không có quyền</span>'}
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        function showWeeklyReportModal(reportId = null) {
            const modal = document.getElementById('weeklyReportModal');
            const title = document.getElementById('weeklyReportModalTitle');
            const form = document.getElementById('weeklyReportForm');
            
            if (reportId) {
                title.textContent = 'Sửa Báo cáo Tuần';
                // Load report data - implement if needed
            } else {
                title.textContent = 'Tạo Báo cáo Tuần mới';
                form.reset();
                document.getElementById('reportYear').value = new Date().getFullYear();
                document.getElementById('isoWeek').value = getISOWeek(new Date());
                document.getElementById('weeklyTasksList').innerHTML = '';
            }
            
            modal.style.display = 'block';
        }

        let weeklyTaskIndex = 0;
        function addWeeklyTask() {
            const container = document.getElementById('weeklyTasksList');
            const taskIndex = weeklyTaskIndex++;
            
            const userTasks = db.tasks.filter(t => t.user_id === currentUser.id);
            const taskOptions = userTasks.map(task => {
                return `<option value="${task.task_id}">${task.task_name}</option>`;
            }).join('');
            
            const taskHtml = `
                <div class="task-item" id="weeklyTask_${taskIndex}">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <h4>Công việc ${taskIndex + 1}</h4>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeWeeklyTask(${taskIndex})">Xóa</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>Chọn công việc *</label>
                            <select class="form-control" name="task_id_${taskIndex}" onchange="updateProjectInfo(${taskIndex})" required>
                                <option value="">Chọn công việc</option>
                                ${taskOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Dự án</label>
                            <div id="project_info_${taskIndex}" class="project-info">Chưa chọn công việc</div>
                        </div>
                        <div class="form-group">
                            <label>Số giờ làm trong tuần *</label>
                            <input type="number" class="form-control" name="duration_week_${taskIndex}" min="0" step="0.5" required>
                        </div>
                        <div class="form-group">
                            <label>Tiến độ (%)</label>
                            <input type="number" class="form-control" name="progress_pct_${taskIndex}" min="0" max="100" value="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ghi chú</label>
                        <input type="text" class="form-control" name="week_note_${taskIndex}">
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', taskHtml);
        }

        function updateProjectInfo(taskIndex) {
            const taskSelect = document.querySelector(`[name="task_id_${taskIndex}"]`);
            const projectInfoDiv = document.getElementById(`project_info_${taskIndex}`);
            
            if (taskSelect.value) {
                const task = db.tasks.find(t => t.task_id === taskSelect.value);
                if (task) {
                    const project = db.projects.find(p => p.project_id === task.project_id);
                    if (project) {
                        projectInfoDiv.innerHTML = `${project.proj_name} (${project.customer || 'N/A'})`;
                    }
                }
            } else {
                projectInfoDiv.innerHTML = 'Chưa chọn công việc';
            }
        }

        function removeWeeklyTask(index) {
            const task = document.getElementById(`weeklyTask_${index}`);
            if (task) {
                task.remove();
            }
        }

        // ========================================
        // USER ACTIVITY
        // ========================================
        async function loadActivity() {
            try {
                const tbody = document.querySelector('#activityTable tbody');
                tbody.innerHTML = '<tr><td colspan="9" class="loading">Đang tải dữ liệu...</td></tr>';
                
                let query = supabase
                    .from('user_activities')
                    .select('*');
                
                // Apply filters
                const yearFilter = document.getElementById('activityYearFilter').value;
                const weekFrom = parseInt(document.getElementById('activityWeekFrom').value);
                const weekTo = parseInt(document.getElementById('activityWeekTo').value);
                const projectFilter = document.getElementById('activityProjectFilter').value;
                
                if (yearFilter) {
                    query = query.eq('year', parseInt(yearFilter));
                }
                if (weekFrom) {
                    query = query.gte('iso_week', weekFrom);
                }
                if (weekTo) {
                    query = query.lte('iso_week', weekTo);
                }
                if (projectFilter) {
                    query = query.eq('project_id', projectFilter);
                }
                
                const { data: activities, error } = await query;
                
                if (error) throw error;
                
                displayActivities(activities);
            } catch (error) {
                console.error('Error loading activities:', error);
                const tbody = document.querySelector('#activityTable tbody');
                tbody.innerHTML = `<tr><td colspan="9" class="error">Lỗi tải dữ liệu: ${error.message}</td></tr>`;
            }
        }

        function displayActivities(activities) {
            const tbody = document.querySelector('#activityTable tbody');
            
            if (!activities || activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Không có dữ liệu</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            activities.forEach(activity => {
                tbody.innerHTML += `
                    <tr>
                        <td>${activity.year}</td>
                        <td>${activity.iso_week}</td>
                        <td>${activity.full_name}</td>
                        <td>${activity.code_id || '-'}</td>
                        <td>${activity.proj_name}</td>
                        <td>${activity.customer || '-'}</td>
                        <td>${activity.task_lines}</td>
                        <td>${activity.hours_week || 0}</td>
                        <td>
                            <div class="progress-bar" style="width: 100px; display: inline-block;">
                                <div class="progress-fill" style="width: ${activity.avg_progress_pct || 0}%"></div>
                            </div>
                            ${activity.avg_progress_pct || 0}%
                        </td>
                    </tr>
                `;
            });
        }

        // ========================================
        // PROJECT PROGRESS
        // ========================================
        async function loadProgress() {
            try {
                const tbody = document.querySelector('#progressTable tbody');
                const statsContainer = document.getElementById('progressStats');
                
                tbody.innerHTML = '<tr><td colspan="12" class="loading">Đang tải dữ liệu...</td></tr>';
                
                const { data: progressData, error } = await supabase
                    .from('project_progress')
                    .select('*');
                
                if (error) throw error;
                
                // Update stats
                const totalProjects = progressData.length;
                const activeProjects = progressData.filter(p => p.status === 'active').length;
                const totalHours = progressData.reduce((sum, p) => sum + (p.hours_spent || 0), 0);
                const avgProgress = totalProjects > 0 
                    ? Math.round(progressData.reduce((sum, p) => sum + (p.overall_progress_pct || 0), 0) / totalProjects)
                    : 0;
                
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${totalProjects}</div>
                        <div class="stat-label">Tổng số dự án</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${activeProjects}</div>
                        <div class="stat-label">Dự án đang hoạt động</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalHours}h</div>
                        <div class="stat-label">Tổng giờ làm</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${avgProgress}%</div>
                        <div class="stat-label">Tiến độ trung bình</div>
                    </div>
                `;
                
                // Update table
                tbody.innerHTML = '';
                progressData.forEach(project => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${project.project_id}</td>
                            <td>${project.proj_name}</td>
                            <td>${project.customer || '-'}</td>
                            <td>${formatDate(project.start_date)}</td>
                            <td>${formatDate(project.end_date)}</td>
                            <td>${getStatusBadge(project.status)}</td>
                            <td>${project.total_tasks || 0}</td>
                            <td>${project.completed_tasks || 0}</td>
                            <td>
                                <div class="progress-bar" style="width: 100px; display: inline-block;">
                                    <div class="progress-fill" style="width: ${project.overall_progress_pct || 0}%"></div>
                                </div>
                                ${project.overall_progress_pct || 0}%
                            </td>
                            <td>${project.total_hours_estimated || 0}h</td>
                            <td>${project.hours_spent || 0}h</td>
                            <td>${project.team_members || 0}</td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error loading progress:', error);
                const tbody = document.querySelector('#progressTable tbody');
                tbody.innerHTML = `<tr><td colspan="12" class="error">Lỗi tải dữ liệu: ${error.message}</td></tr>`;
            }
        }

        // ========================================
        // FORM SUBMISSIONS
        // ========================================
        document.getElementById('projectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const projectId = document.getElementById('projectId').value;
                const formData = {
                    proj_name: document.getElementById('projName').value,
                    customer: document.getElementById('customer').value,
                    description: document.getElementById('description').value,
                    start_date: document.getElementById('startDate').value || null,
                    end_date: document.getElementById('endDate').value || null,
                    status: document.getElementById('status').value
                };
                
                if (projectId) {
                    // Update existing project
                    const { error } = await supabase
                        .from('projects')
                        .update(formData)
                        .eq('project_id', projectId);
                    
                    if (error) throw error;
                } else {
                    // Create new project with auto-generated ID
                    const year = new Date().getFullYear().toString().slice(-2);
                    const seq = (db.projects.length + 1).toString().padStart(3, '0');
                    const newProjectId = `${year}_${seq}`;
                    
                    const { error } = await supabase
                        .from('projects')
                        .insert({
                            project_id: newProjectId,
                            ...formData,
                            created_by: currentUser.id // RLS sẽ tự động thêm field này
                        });
                    
                    if (error) throw error;
                }
                
                closeModal('projectModal');
                await loadProjects();
                populateFilters();
                showSuccess('Lưu dự án thành công!');
            } catch (error) {
                console.error('Error saving project:', error);
                alert('Lỗi lưu dự án: ' + error.message);
            }
        });

        document.getElementById('taskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const taskId = document.getElementById('taskId').value;
                const formData = {
                    project_id: document.getElementById('taskProjectId').value,
                    user_id: document.getElementById('taskUserId').value,
                    task_name: document.getElementById('taskName').value,
                    description: document.getElementById('taskDescription').value,
                    start_date: document.getElementById('taskStartDate').value || null,
                    end_date: document.getElementById('taskEndDate').value || null,
                    total_duration: parseFloat(document.getElementById('totalDuration').value) || 0,
                    progress_pct: parseInt(document.getElementById('progressPct').value) || 0,
                    status: document.getElementById('taskStatus').value
                };
                
                if (taskId) {
                    // Update existing task
                    const { error } = await supabase
                        .from('tasks')
                        .update(formData)
                        .eq('task_id', taskId);
                    
                    if (error) throw error;
                } else {
                    // Create new task with auto-generated ID
                    const project = db.projects.find(p => p.project_id === formData.project_id);
                    const user = db.users.find(u => u.id === formData.user_id);
                    const taskSeq = (db.tasks.filter(t => t.project_id === formData.project_id).length + 1).toString().padStart(4, '0');
                    
                    const newTaskId = `${formData.project_id}_${user.code_id || '00'}_${taskSeq}`;
                    
                    const { error } = await supabase
                        .from('tasks')
                        .insert({
                            task_id: newTaskId,
                            ...formData,
                            created_by: currentUser.id
                        });
                    
                    if (error) throw error;
                }
                
                closeModal('taskModal');
                await loadTasks();
                showSuccess('Lưu công việc thành công!');
            } catch (error) {
                console.error('Error saving task:', error);
                alert('Lỗi lưu công việc: ' + error.message);
            }
        });

        document.getElementById('weeklyReportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const reportData = {
                    user_id: currentUser.id,
                    year: parseInt(document.getElementById('reportYear').value),
                    iso_week: parseInt(document.getElementById('isoWeek').value),
                    report_note: document.getElementById('reportNote').value,
                    status: 'draft',
                    created_by: currentUser.id
                };
                
                // Insert report
                const { data: report, error: reportError } = await supabase
                    .from('weekly_reports')
                    .insert(reportData)
                    .select()
                    .single();
                
                if (reportError) throw reportError;
                
                // Collect and insert tasks
                const taskItems = document.querySelectorAll('#weeklyTasksList .task-item');
                const tasks = [];
                
                for (let i = 0; i < taskItems.length; i++) {
                    const item = taskItems[i];
                    const taskIdInput = item.querySelector(`[name^="task_id_"]`);
                    if (taskIdInput && taskIdInput.value) {
                        tasks.push({
                            report_id: report.report_id,
                            task_id: taskIdInput.value,
                            duration_week: parseFloat(item.querySelector(`[name^="duration_week_"]`).value) || 0,
                            progress_pct: parseInt(item.querySelector(`[name^="progress_pct_"]`).value) || 0,
                            week_note: item.querySelector(`[name^="week_note_"]`).value
                        });
                    }
                }
                
                if (tasks.length > 0) {
                    const { error: tasksError } = await supabase
                        .from('weekly_report_tasks')
                        .insert(tasks);
                    
                    if (tasksError) throw tasksError;
                }
                
                closeModal('weeklyReportModal');
                await loadWeeklyReports();
                showSuccess('Báo cáo tuần đã được lưu thành công!');
            } catch (error) {
                console.error('Error saving weekly report:', error);
                alert('Lỗi lưu báo cáo: ' + error.message);
            }
        });

        // ========================================
        // HELPER FUNCTIONS
        // ========================================
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Enhanced canEdit function with RLS awareness
        function canEdit(type, item) {
            const role = currentUser?.role || 'staff';
            
            if (role === 'admin') return true;
            
            switch(type) {
                case 'project':
                    // Creator or admin can edit
                    return item.created_by === currentUser.id || role === 'pm';
                    
                case 'task':
                    // Assigned user, creator or admin can edit
                    return item.user_id === currentUser.id || 
                           item.created_by === currentUser.id ||
                           role === 'admin';
                           
                case 'report':
                    // Only own draft reports can be edited
                    return item.user_id === currentUser.id && item.status === 'draft';
                    
                default:
                    return false;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        function getStatusBadge(status) {
            const statusMap = {
                'active': '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Đang hoạt động</span>',
                'completed': '<span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Đã hoàn thành</span>',
                'paused': '<span style="background: #ffc107; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Tạm dừng</span>',
                'pending': '<span style="background: #17a2b8; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Chờ xử lý</span>',
                'in_progress': '<span style="background: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Đang thực hiện</span>',
                'draft': '<span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Nháp</span>',
                'submitted': '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Đã nộp</span>'
            };
            return statusMap[status] || status;
        }

        function getISOWeek(date) {
            const tempDate = new Date(date.getTime());
            tempDate.setHours(0, 0, 0, 0);
            tempDate.setDate(tempDate.getDate() + 3 - (tempDate.getDay() + 6) % 7);
            const week1 = new Date(tempDate.getFullYear(), 0, 4);
            return 1 + Math.round(((tempDate.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }
        }

        function showSuccess(message) {
            // Create temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '9999';
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // ========================================
        // AUTOCOMPLETE & SEARCH FUNCTIONS
        // ========================================
        function setupAutocomplete(inputId, suggestionsId, data, searchFields, onSelect) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            
            input.addEventListener('focus', () => {
                if (input.value.length > 0) {
                    showSuggestions(input.value, data, searchFields, suggestions, onSelect);
                }
            });
            
            input.addEventListener('blur', () => {
                setTimeout(() => {
                    suggestions.style.display = 'none';
                }, 200);
            });
        }

        function showSuggestions(query, data, searchFields, suggestionsEl, onSelect) {
            const filtered = data.filter(item => {
                return searchFields.some(field => 
                    item[field] && item[field].toLowerCase().includes(query.toLowerCase())
                );
            });
            
            if (filtered.length === 0) {
                suggestionsEl.style.display = 'none';
                return;
            }
            
            suggestionsEl.innerHTML = '';
            filtered.slice(0, 5).forEach(item => {
                const div = document.createElement('div');
                div.className = 'autocomplete-suggestion';
                div.innerHTML = highlightMatch(item[searchFields[0]], query);
                if (searchFields.length > 1 && item[searchFields[1]]) {
                    div.innerHTML += ` <small>(${item[searchFields[1]]})</small>`;
                }
                div.onclick = () => onSelect(item);
                suggestionsEl.appendChild(div);
            });
            
            suggestionsEl.style.display = 'block';
        }

        function highlightMatch(text, query) {
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<strong>$1</strong>');
        }

        // Search Functions
        function searchProjects(query) {
            if (!query) {
                loadProjects();
                return;
            }
            
            const suggestions = document.getElementById('projectSearchSuggestions');
            showSuggestions(query, db.projects, ['proj_name', 'customer'], suggestions, (project) => {
                document.getElementById('projectSearch').value = project.proj_name;
                suggestions.style.display = 'none';
                filterProjects(project.project_id);
            });
            
            // Also filter the table
            const filtered = db.projects.filter(p => 
                p.proj_name.toLowerCase().includes(query.toLowerCase()) ||
                (p.customer && p.customer.toLowerCase().includes(query.toLowerCase()))
            );
            displayProjects(filtered);
        }

        function searchTasks(query) {
            if (!query) {
                loadTasks();
                return;
            }
            
            const suggestions = document.getElementById('taskSearchSuggestions');
            showSuggestions(query, db.tasks, ['task_name'], suggestions, (task) => {
                document.getElementById('taskSearch').value = task.task_name;
                suggestions.style.display = 'none';
                filterTasks(task.task_id);
            });
            
            const filtered = db.tasks.filter(t => 
                t.task_name.toLowerCase().includes(query.toLowerCase())
            );
            displayTasks(filtered);
        }

        function searchUserActivity(query) {
            if (!query) {
                loadActivity();
                return;
            }
            
            const suggestions = document.getElementById('userActivitySuggestions');
            showSuggestions(query, db.users, ['full_name', 'code_id'], suggestions, (user) => {
                document.getElementById('userActivitySearch').value = user.full_name;
                suggestions.style.display = 'none';
                filterActivityByUser(user.id);
            });
        }

        // Filter Functions
        function filterProjects(projectId) {
            const filtered = db.projects.filter(p => p.project_id === projectId);
            displayProjects(filtered);
        }

        function filterTasks(taskId) {
            const filtered = db.tasks.filter(t => t.task_id === taskId);
            displayTasks(filtered);
        }

        async function filterActivityByUser(userId) {
            // Reload activity with user filter
            const tbody = document.querySelector('#activityTable tbody');
            tbody.innerHTML = '<tr><td colspan="9" class="loading">Đang tải dữ liệu...</td></tr>';
            
            try {
                const { data: activities, error } = await supabase
                    .from('user_activities')
                    .select('*')
                    .eq('user_id', userId);
                
                if (error) throw error;
                displayActivities(activities);
            } catch (error) {
                console.error('Error filtering activities:', error);
                tbody.innerHTML = `<tr><td colspan="9" class="error">Lỗi tải dữ liệu: ${error.message}</td></tr>`;
            }
        }

        // Populate filters
        function populateFilters() {
            // Populate project filters
            const projectFilters = ['taskProjectFilter', 'activityProjectFilter'];
            projectFilters.forEach(filterId => {
                const select = document.getElementById(filterId);
                if (select) {
                    select.innerHTML = '<option value="">Tất cả dự án</option>';
                    db.projects.forEach(project => {
                        select.innerHTML += `<option value="${project.project_id}">${project.proj_name}</option>`;
                    });
                }
            });
            
            // Populate user filter
            const userFilter = document.getElementById('taskUserFilter');
            if (userFilter) {
                userFilter.innerHTML = '<option value="">Tất cả người dùng</option>';
                db.users.forEach(user => {
                    userFilter.innerHTML += `<option value="${user.id}">${user.full_name}</option>`;
                });
            }
        }

        function populateWeekFilter() {
            const weekFilter = document.getElementById('reportWeekFilter');
            if (weekFilter) {
                weekFilter.innerHTML = '<option value="">Tất cả các tuần</option>';
                for (let i = 1; i <= 53; i++) {
                    weekFilter.innerHTML += `<option value="${i}">Tuần ${i}</option>`;
                }
            }
        }

        // Modal close when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Initialize autocomplete after data loads
        async function initializeAutocomplete() {
            // Wait for data to be loaded
            setTimeout(() => {
                setupAutocomplete('projectSearch', 'projectSearchSuggestions', db.projects, ['proj_name', 'customer'], (project) => {
                    document.getElementById('projectSearch').value = project.proj_name;
                    document.getElementById('projectSearchSuggestions').style.display = 'none';
                    filterProjects(project.project_id);
                });
                
                setupAutocomplete('taskSearch', 'taskSearchSuggestions', db.tasks, ['task_name'], (task) => {
                    document.getElementById('taskSearch').value = task.task_name;
                    document.getElementById('taskSearchSuggestions').style.display = 'none';
                    filterTasks(task.task_id);
                });
                
                setupAutocomplete('userActivitySearch', 'userActivitySuggestions', db.users, ['full_name'], (user) => {
                    document.getElementById('userActivitySearch').value = user.full_name;
                    document.getElementById('userActivitySuggestions').style.display = 'none';
                    filterActivityByUser(user.id);
                });
            }, 1000);
        }

        // Call this after loading initial data
        window.addEventListener('load', () => {
            if (currentUser) {
                initializeAutocomplete();
            }
        });
    </script>
</body>
</html>
